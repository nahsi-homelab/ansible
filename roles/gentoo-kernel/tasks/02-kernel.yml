- name: create kernel related directories
  file:
    dest: "{{ item }}"
    state: directory
  loop:
    - /etc/kernel/config.d/
    - /etc/kernel/kconfig.d/
    - /etc/kernel/postinst.d/
    - /etc/portage/savedconfig/sys-kernel/
    - /etc/portage/patches/sys-kernel/gentoo-kernel/
    - /etc/portage/package.mask/
    - /etc/portage/package.use/

- name: copy gentoo-kernel savedconfig
  copy:
    src: "configs/{{ arch }}-base.config"
    dest: "/etc/portage/savedconfig/sys-kernel/gentoo-kernel"
  notify: rebuild kernel

- name: create linux-firmware savedconfig
  template:
    src: linux-firmware.j2
    dest: "/etc/portage/savedconfig/sys-kernel/linux-firmware"

- name: configure builtin firmare
  copy:
    content: "CONFIG_EXTRA_FIRMWARE=\"{{ kernel_firmware | join(' ') }}\""
    dest: /etc/kernel/config.d/firmware.config
  when: kernel_firmware | length > 0
  notify: rebuild kernel

- name: copy kconfigs
  copy:
    src: "kconfig.d/{{ item }}"
    dest: "/etc/kernel/kconfig.d/{{ item }}"
  loop: "{{ kernel_kconfigs }}"
  notify: rebuild kernel

- name: create custom Kconfig to include in Linux src
  template:
    src: Kconfig.j2
    dest: "/etc/kernel/Kconfig"
  notify: rebuild kernel

- name: use custom Kconfig when building kernel
  copy:
    src: custom-kconfig.patch
    dest: /etc/portage/patches/sys-kernel/gentoo-kernel/custom-kconfig.patch

- name: copy postinstall scripts
  copy:
    src: "postinst.d/{{ item }}"
    dest: "/etc/kernel/postinst.d/{{ item }}"
    mode: 745
  loop: "{{ kernel_postinst }}"
  notify: update initramfs

- name: force gentoo-kernel version
  copy:
    content: |
      >sys-kernel/gentoo-kernel-{{ kernel_version }}
      >sys-kernel/gentoo-sources-{{ kernel_version }}
    dest: /etc/portage/package.mask/kernel.mask

- name: enable savedconfigs
  copy:
    content: |
      sys-kernel/gentoo-kernel savedconfig
      sys-kernel/linux-firmware savedconfig
    dest: /etc/portage/package.use/kernel.use

- name: install linux-firmware
  portage:
    package: sys-kernel/linux-firmware
    state: latest
  when: kernel_firmware | length > 0

- name: install gentoo-kernel
  portage:
    package: sys-kernel/gentoo-kernel
    state: latest
  notify: rebuild modules

- name: remove old kernels
  portage:
    package: sys-kernel/gentoo-kernel
    state: absent
    depclean: yes
