base_filesystems:
  - path: "/tmp"
    src: "tmpfs"
    opts: "rw,nosuid,noatime,nodev,size=2G,mode=1777"
    fstype: "tmpfs"
    state: "mounted"

  - path: "/sys/fs/bpf"
    src: "bpffs"
    fstype: "bpf"
    state: "mounted"

base_dns: |
  resolv_conf="/etc/resolv.conf"
  search_domains="node.consul service.consul"

base_dnsmasq_config: ""

base_packages_miletos:
  - app-laptop/mbpfan
  - sys-power/thermald
  - x11-misc/autorandr
  - app-emulation/virt-viewer
  - x11-misc/cbatticon
  - app-misc/brillo
  - x11-libs/libva-intel-driver
base_packages: >
  {{
    base_packages_gentoo +
    base_packages_miletos +
    base_packages_workstation | unique
  }}

base_services:
  - name: "mbpfan"
    runlevel: "default"
    enabled: true
    state: "started"

  - name: "thermald"
    runlevel: "default"
    enabled: true
    state: "started"

  - name: "elogind"
    runlevel: "default"
    enabled: true
    state: "started"

  - name: "alsasound"
    runlevel: "default"
    enabled: true
    state: "started"

base_iwd: |
  [General]
  EnableNetworkConfiguration=true
  [Network]
  RoutePriorityOffset=200
  NameResolvingService=resolvconf

base_udev_rules:
  10_disable_bluetooth: |
    SUBSYSTEM=="rfkill", ATTR{type}=="bluetooth", ATTR{state}="0"

  10_wifi_powersave: |
    ACTION=="add", SUBSYSTEM=="net", KERNEL=="wl*", RUN+="/usr/bin/iwctl dev $name set power_save on"

  10_pci_pm: |
    SUBSYSTEM=="pci", ATTR{power/control}="auto"

  # 10_usb_autosuspend: |
  #   ACTION=="add", SUBSYSTEM=="usb", ATTR{idVendor}=="2717", ATTR{idProduct}=="5001", GOTO="power_usb_rules_end"
  #   ACTION=="add", SUBSYSTEM=="usb", TEST=="power/control", ATTR{power/control}="auto" LABEL="power_usb_rules_end"

  10_sata_autosuspend: |
    ACTION=="add", SUBSYSTEM=="scsi_host", KERNEL=="host*", ATTR{link_power_management_policy}="med_power_with_dipm"

  20_vfio: |
    SUBSYSTEM=="vfio", OWNER="root", GROUP="kvm", MODE="0660"

  30_autorandr: |
    ACTION=="change", SUBSYSTEM=="drm", RUN+="/usr/bin/autorandr --batch --change --default default"

base_portage_makeconf_miletos:
  COMMON_FLAGS: "-O2 -march=broadwell -pipe"
  RUSTFLAGS: "-C target-cpu=broadwell"
  CPU_FLAGS_X86: "aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3 rdrand"
  VIDEO_CARDS: "intel i965 iris"
  LUA_TARGETS: "luajit"
  LUA_SINGLE_TARGET: "luajit"
  LLVM_TARGETS: "X86"
  DISTCC_HOSTS: "pergamon.node.consul/32"
  FEATURES: "parallel-install distcc"
  INPUT_DEVICES: "synaptics evdev"
  ACCEPT_LICENSE: "* -@EULA google-chrome"
base_portage_makeconf: >
  {{
    base_portage_makeconf_gentoo |
    combine(base_portage_makeconf_miletos, recursive=true)
  }}

base_portage_env:
  notmpfs: |
    PORTAGE_TMPDIR="/var/notmpfs"

base_portage_package_env:
  notmpfs: |
    www-client/chromium base-notmpfs.conf
    dev-qt/qtwebengine base-notmpfs.conf

base_portage_package_use_miletos:
  system: |
    media-libs/mesa -gles2
    app-misc/brillo -ddcci

base_portage_package_use: >
  {{
    base_portage_package_use_miletos |
    combine(base_portage_package_use_workstation, recursive=true) |
    combine(base_portage_package_use_gentoo, recursive=true)
  }}
