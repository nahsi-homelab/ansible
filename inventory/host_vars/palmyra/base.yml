base_filesystems:
  - path: "/var/tmp"
    src: "tmpfs"
    opts: "rw,nosuid,noatime,nodev,size=75%,mode=1777"
    fstype: "tmpfs"
    state: "mounted"

  - path: "/tmp"
    src: "tmpfs"
    opts: "rw,nosuid,noatime,nodev,size=2G,mode=1777"
    fstype: "tmpfs"
    state: "mounted"

  - path: "/sys/fs/bpf"
    src: "bpffs"
    fstype: "bpf"
    state: "mounted"

base_network: |
  config_enp1s0="10.1.10.20/24"
  routes_enp1s0="default via 10.1.10.1"

base_network_interfaces:
  - name: "enp1s0"

base_packages_palmyra:
  - net-misc/r8168
base_packages: >
  {{
    base_packages_gentoo +
    base_packages_palmyra | unique
  }}

base_portage_makeconf_palmyra:
  COMMON_FLAGS: "-O2 -march=amdfam10 -mcx16 -mpopcnt"
  RUSTFLAGS: "-C target-cpu=amdfam10"
  CPU_FLAGS_X86: "3dnow 3dnowext popcnt mmx mmxext sse sse2 sse3 sse4a"
  INPUT_DEVICES: "evdev"
  LUA_TARGETS: "luajit"
  LUA_SINGLE_TARGET: "luajit"
  DISTCC_HOSTS: "antiochia.node.consul/16"
  FEATURES: "parallel-install distcc"
base_portage_makeconf: >
  {{
    base_portage_makeconf_gentoo |
    combine(base_portage_makeconf_palmyra, recursive=true)
  }}

base_zfs_datasets:
  - name: "main"
    properties:
      compression: "zstd"
      relatime: "on"
      acltype: "posix"
      xattr: "sa"
      dnodesize: "auto"
      mountpoint: "none"
      canmount: "off"
      normalization: "formD"

  - name: "storage"
    properties:
      compression: "zstd"
      relatime: "on"
      acltype: "posix"
      xattr: "sa"
      dnodesize: "auto"
      mountpoint: "none"
      canmount: "off"
      normalization: "formD"

  - name: "main/system/gentoo"
    properties:
      canmount: "noauto"
      mountpoint: "/"
      org.zfsbootmenu:commandline: "ro quiet loglevel=0"
      org.zfsbootmenu:kernel: "5.10"
    owner: "root"
    group: "root"
    mode: "0755"

  - name: "main/containers"
    owner: "root"
    group: "root"
    mode: "0710"

  - name: "main/users/nahsi/home"
    properties:
      mountpoint: "/home/nahsi"
    owner: "nahsi"
    group: "nahsi"
    mode: "0755"

  - name: "main/data/postgres"
    properties:
      atime: "off"
      compression: "lz4"
      logbias: "throughput"
      primarycache: "metadata"
      recordsize: "8k"
      mountpoint: "/var/lib/postgres"
    owner: "999"
    group: "999"
    mode: "0700"

  - name: "main/data/mariadb"
    properties:
      atime: "off"
      compression: "lz4"
      logbias: "throughput"
      primarycache: "metadata"
      recordsize: "16k"
      mountpoint: "/var/lib/mariadb"
    owner: "999"
    group: "999"
    mode: "0700"

  - name: "main/data/zookeeper"
    properties:
      atime: "off"
      mountpoint: "/var/lib/zookeeper"
    owner: "1001"
    group: "1001"
    mode: "0700"

  - name: "main/data/kafka"
    properties:
      atime: "off"
      mountpoint: "/var/lib/kafka"
    owner: "1001"
    group: "1001"
    mode: "0700"

  - name: "main/data/minio"
    properties:
      atime: "off"
      mountpoint: "/var/lib/minio"
      quota: "50G"
    owner: "nobody"
    group: "nobody"
    mode: "0700"

  - name: "main/data/redis-mail"
    properties:
      atime: "off"
      mountpoint: "/var/lib/redis-mail"
      quota: "1G"
    owner: "nobody"
    group: "nobody"

  - name: "main/data/nats"
    properties:
      atime: "off"
      compression: "zstd"
      mountpoint: "/var/lib/nats"
      quota: "10G"
    mode: "0750"

  - name: "main/data/seaweedfs-master"
    properties:
      atime: "off"
      compression: "zstd"
      mountpoint: "/var/lib/seaweedfs-master"
      quota: "1G"
    mode: "0700"
    owner: "nobody"
    group: "nobody"

  - name: "main/data/seaweedfs-index"
    properties:
      atime: "off"
      compression: "zstd"
      mountpoint: "/var/lib/seaweedfs-index"
      quota: "10G"
    mode: "0700"
    owner: "nobody"
    group: "nobody"

  - name: "main/data/seaweedfs-ssd"
    properties:
      atime: "off"
      compression: "zstd"
      mountpoint: "/var/lib/seaweedfs-ssd"
      quota: "200G"
    mode: "0700"
    owner: "nobody"
    group: "nobody"
