base_portage_package_use_all:
  common: |
    sys-devel/gcc pgo
    dev-lang/rust clippy rls rustfmt
    net_misc/openssh -pam
    net-analyzer/tcpdump -samba -smi

base_portage_package_use: "{{ base_portage_package_use_all }}"

base_portage_distcc_cores: 16
# --jobs=N
# where N is number of logical cores
# when using distcc N is a number of local + remote logical cores
base_portage_jobs: >-
  {{
    (ansible_processor_cores * ansible_processor_threads_per_core) +
    base_portage_distcc_cores
  }}
# --load-average=X.Y
# where X.Y=N*0.9 where N is a number of local cores (even with distcc enabled)
base_portage_la: >-
  {{
    ansible_processor_cores * ansible_processor_threads_per_core |
    float * 0.9
  }}

# https://wiki.gentoo.org/wiki/GENTOO_MIRRORS
base_portage_mirrors:
  - https://mirror.yandex.ru/gentoo-distfiles/
  - https://distfiles.gentoo.org/

# https://wiki.gentoo.org/wiki//etc/portage/make.conf
# https://github.com/gentoo/portage/blob/master/cnf/make.conf.example
base_portage_makeconf_all:
  CHOST: "x86_64-pc-linux-gnu"
  # -march=native won't work with distcc
  COMMON_FLAGS: "-O2 -march=native"
  CFLAGS: "${COMMON_FLAGS}"
  CXXFLAGS: "${COMMON_FLAGS}"
  FCFLAGS: "${COMMON_FLAGS}"
  FFLAGS: "${COMMON_FLAGS}"
  EMERGE_DEFAULT_OPTS: "--jobs={{ base_portage_jobs }} --load-average={{ base_portage_la }} --quiet-build"
  MAKEOPTS: "--jobs={{ base_portage_jobs }} --load-average={{ base_portage_la }}"
  PORTAGE_NICENESS: "19"
  # portage uses ${PORTAGE_TMPDIR}/portage
  # it's a good idea to mount tmpfs or zram device to this directory
  # to reduce disk wear
  # https://wiki.gentoo.org/wiki/Portage_TMPDIR_on_tmpfs
  PORTAGE_TMPDIR: "/var/tmp"
  PORTAGE_ELOG_CLASSES: "log warn error"
  PORTAGE_ELOG_SYSTEM: "syslog"
  GENTOO_MIRRORS: "{{ base_portage_mirrors | join(' ') }}"
  ACCEPT_KEYWORDS: "~amd64"
  ACCEPT_LICENSE: "* -@EULA"
  ABI_X86: "64"
  L10N: "en"
  LINGUAS: "en"
  # This sets the language of build output to English
  LC_MESSAGES: "C"
  USE: "{{ base_portage_use | join(' ') }}"

base_portage_makeconf: "{{ base_portage_makeconf_all }}"
