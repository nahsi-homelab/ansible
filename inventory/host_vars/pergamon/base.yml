base_filesystems:
  - path: "/var/tmp"
    src: "tmpfs"
    opts: "rw,nosuid,noatime,nodev,size=75%,mode=1777"
    fstype: "tmpfs"
    state: "mounted"

  - path: "/tmp"
    src: "tmpfs"
    opts: "rw,nosuid,noatime,nodev,size=2G,mode=1777"
    fstype: "tmpfs"
    state: "mounted"

  - path: "/sys/fs/bpf"
    src: "bpffs"
    fstype: "bpf"
    state: "mounted"

base_dnsmasq_config: |
  interface=enp4s0.10
  dhcp-range=vlan10,10.2.10.200,10.2.10.250,75h
  dhcp-option=vlan10,3,10.2.10.10
  dhcp-option=vlan10,6,10.2.10.10

  interface=enp4s0.30
  dhcp-range=vlan30,10.2.30.200,10.2.30.250,75h
  dhcp-option=vlan30,3,10.2.30.10
  dhcp-option=vlan30,6,10.2.30.10

  interface=enp4s0.50
  dhcp-range=vlan50,10.2.50.200,10.2.50.250,75h
  dhcp-option=vlan50,3,10.2.50.10
  dhcp-option=vlan50,6,10.2.50.10

  dhcp-host=58:bf:25:22:b1:54,10.2.30.5
  dhcp-host=6c:29:90:27:12:e1,10.2.30.11
  dhcp-host=d8:a0:11:24:34:8c,10.2.30.12
  dhcp-host=3c:6a:9d:15:8b:17,10.2.30.31
  dhcp-host=3c:6a:9d:1a:4d:6c,10.2.30.32

  listen-address=127.0.0.1,172.17.0.1

  interface=docker0
  interface=lo
  bind-interfaces

  server=/consul/127.0.0.1#8600
  server={{ nameserver }}

  rev-server=0.0.0.0/8,127.0.0.1#8600
  rev-server=10.0.0.0/8,127.0.0.1#8600
  rev-server=127.0.0.1/8,127.0.0.1#8600
  rev-server=172.17.0.0/16,127.0.0.1#8600
  rev-server=192.168.0.0/16,127.0.0.1#8600

  local-service
  no-poll
  no-resolv

base_network: |
  # pppoe
  config_enp5s0=null
  config_ppp0="ppp"
  link_ppp0="enp5s0"
  plugins_ppp0="pppoe"
  pppd_ppp0="
    noauth
    defaultroute
    mru 1492
    mtu 1492
    lcp-echo-interval 15 lcp-echo-failure 3
    logfile /var/log/pppoe.log
    noaccomp noccp nobsdcomp nodeflate nopcomp novj novjccomp"

  username_ppp0={{ lookup('hashi_vault', 'secret/data/ISP/asia:username') }}
  password_ppp0={{ lookup('hashi_vault', 'secret/data/ISP/asia:password') }}

  rc_net_ppp0_need="net.enp4s0"

  # a workaround for 'WARNING: net.ppp0 has started, but is inactive'
  preup() {
    if [ "${IFACE}" == "ppp0" ]; then
      trap 'mark_service_started' EXIT
    fi
    return 0
  }

  # lan
  config_enp4s0="null"

  vlans_enp4s0="10 30 50"
  config_enp4s0_10="10.2.10.10/24"
  config_enp4s0_30="10.2.30.10/24"
  config_enp4s0_50="10.2.50.10/24"

base_network_interfaces:
  - name: "enp4s0"
  - name: "enp5s0"
    start: false
    enable: false
  - name: "ppp0"

base_packages_pergamon:
  - net-misc/r8125
  - net-dialup/ppp
  - media-plugins/hyperion
  - media-sound/beets
  - media-tv/v4l-utils
  - media-video/v4l2loopback
  - media-video/obs-studio
  - media-gfx/inkscape
  - media-sound/easyeffects
  - app-emulation/vagrant
  - app-misc/deckmaster
  - media-video/obs-cli
  - app-text/calibre
base_packages: >
  {{
    base_packages_gentoo +
    base_packages_pergamon +
    base_packages_desktop | unique
  }}

base_services:
  - name: "elogind"
    runlevel: "default"
    enabled: true
    state: "started"

  - name: "alsasound"
    runlevel: "default"
    enabled: true
    state: "started"

  - name: "iptables"
    runlevel: "default"
    enabled: true
    state: "started"

base_udev_rules:
  10_streamdeck: |
    SUBSYSTEM=="usb", ATTRS{idVendor}=="0fd9", ATTRS{idProduct}=="0080", MODE:="660", GROUP="usb", SYMLINK+="streamdeck"
  11_moonlander: |
    SUBSYSTEM=="usb", ATTR{idVendor}=="3297", ATTR{idProduct}=="1969", GROUP="plugdev"

base_portage_distcc_cores: 0
base_portage_makeconf_pergamon:
  COMMON_FLAGS: "-O2 -march=znver3"
  RUSTFLAGS: "-C target-cpu=znver3"
  CPU_FLAGS_X86: "aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt rdrand sha sse sse2 sse3 sse4_1 sse4_2 sse4a ssse3"
  VIDEO_CARDS: "amdgpu radeonsi"
  INPUT_DEVICES: "evdev"
  LUA_TARGETS: "luajit"
  LUA_SINGLE_TARGET: "luajit"
  LLVM_TARGETS: "AMDGPU X86"
  FEATURES: "parallel-install"
  ACCEPT_LICENSE: "* -@EULA google-chrome"
base_portage_makeconf: >
  {{
    base_portage_makeconf_gentoo |
    combine(base_portage_makeconf_pergamon, recursive=true)
  }}

base_portage_package_use_pergamon:
  system: |
    media-libs/mesa -classic -gles2

  pergamon: |
    media-plugins/hyperion -v4l -qt-grabber -zeroconf

    media-tv/v4l-utils qt5 -bpf
    media-video/obs-studio truetype v4l

    app-text/poppler cairo

    # audio
    media-video/pipewire pipewire-alsa extra gstreamer jack-sdk
    media-libs/portaudio jack
    media-sound/easyeffects -doc calf mda-lv2 zamaudio
    media-libs/rubberband ladspa
    media-plugins/calf lv2

    # xorg-server
    x11-libs/libdrm video_cards_radeon

    # messengers
    app-text/ghostscript-gpl cups

    # calibre
    app-text/poppler qt5
    app-accessibility/speech-dispatcher python
    app-text/podofo lua_single_target_lua5-4
    app-text/calibre -udisks

base_portage_package_use: >
  {{
    base_portage_package_use_pergamon |
    combine(base_portage_package_use_desktop, recursive=true) |
    combine(base_portage_package_use_gentoo, recursive=true)
  }}

base_portage_env:
  cc1plus: |
    EMERGE_DEFAULT_OPTS="--jobs=8 --load-average={{ base_portage_la }} --quiet-build"
    MAKEOPTS="--jobs=8 --load-average={{ base_portage_la }}"

base_portage_package_env:
  cc1plus: |
    www-client/chromium base-cc1plus.conf
    dev-qt/qtwebengine base-cc1plus.conf
    net-im/telegram-desktop base-cc1plus.conf
    media-gfx/inkscape base-cc1plus.conf

base_zfs_datasets:
  - name: "main"
    properties:
      compression: "zstd"
      relatime: "on"
      acltype: "posix"
      xattr: "sa"
      dnodesize: "auto"
      mountpoint: "none"
      canmount: "off"
      normalization: "formD"

  - name: "main/system/gentoo"
    properties:
      canmount: "noauto"
      mountpoint: "/"
      org.zfsbootmenu:commandline: "ro quiet loglevel=0 amdgpu.dc=0"
      org.zfsbootmenu:kernel: "5.10"
    owner: "root"
    group: "root"
    mode: "0755"

  - name: "main/containers"
    owner: "root"
    group: "root"
    mode: "0710"

  - name: "main/users/nahsi/home"
    properties:
      mountpoint: "/home/nahsi"
    owner: "nahsi"
    group: "nahsi"
    mode: "0755"

  - name: "main/data/minio"
    properties:
      atime: "off"
      mountpoint: "/var/lib/minio"
      quota: "50G"
    owner: "nobody"
    group: "nobody"
    mode: "0700"

  - name: "main/data/mongo"
    properties:
      atime: "off"
      compression: "zstd"
      logbias: "throughput"
      primarycache: "metadata"
      mountpoint: "/var/lib/mongo"
      quota: "100G"
    owner: "999"
    group: "999"
    mode: "0700"

  - name: "main/data/calibre"
    properties:
      atime: "off"
      compression: "zstd"
      mountpoint: "/var/lib/calibre"
      quota: "10G"
    mode: "0755"
    owner: "nahsi"
    group: "nahsi"

  - name: "main/data/calibre-web"
    properties:
      atime: "off"
      compression: "zstd"
      mountpoint: "/var/lib/calibre-web"
      quota: "1G"
    mode: "0750"
    owner: "nahsi"
    group: "nahsi"

  - name: "main/data/home-assistant"
    properties:
      atime: "off"
      mountpoint: "/var/lib/home-assistant"
      quota: "5G"
    owner: "1000"
    group: "1000"
    mode: "0700"

  - name: "main/data/unifi"
    properties:
      atime: "off"
      mountpoint: "/var/lib/unifi"
      compression: "lz4"
    owner: "1000"
    group: "1000"
    mode: "0750"
