base_consolefont: "ter-i24b"

base_filesystems:
  - path: "/tmp"
    src: "tmpfs"
    opts: "rw,nosuid,noatime,nodev,size=2G,mode=1777"
    fstype: "tmpfs"
    state: "mounted"

  - path: "/sys/fs/bpf"
    src: "bpffs"
    fstype: "bpf"
    state: "mounted"

base_docker_config:
  default-runtime: "crun"
  runtimes:
    crun:
      path: "/usr/bin/crun"
  storage-driver: "zfs"
  storage-opts:
    - zfs.fsname=main/containers
  log-driver: "json-file"
  log-opts:
    max-size: "32m"
    max-file: "2"

base_sysctl:
  - name: vm.dirty_writeback_centisecs
    value: 1500
  - name: net.ipv4.ip_forward
    value: 1
  - name: net.ipv4.conf.all.proxy_arp
    value: 1
  - name: net.ipv4.conf.default.rp_filter
    value: 1
  - name: vm.swappiness
    value: 1

base_packages_miletos:
  - app-laptop/mbpfan
  - sys-power/thermald
  - x11-misc/autorandr
base_packages: >
  {{
    base_packages_all +
    base_packages_miletos +
    base_packages_desktop | unique
  }}

base_services:
  - name: "mbpfan"
    runlevel: "default"
    enabled: true
    state: "started"

  - name: "thermald"
    runlevel: "default"
    enabled: true
    state: "started"

  - name: "elogind"
    runlevel: "default"
    enabled: true
    state: "started"

  - name: "alsasound"
    runlevel: "default"
    enabled: true
    state: "started"

base_iwd: |
  [General]
  EnableNetworkConfiguration=true
  [Network]
  RoutePriorityOffset=200
  NameResolvingService=resolvconf

base_udev_rules:
  10_disable_bluetooth: |
    SUBSYSTEM=="rfkill", ATTR{type}=="bluetooth", ATTR{state}="0"

  10_wifi_powersave: |
    ACTION=="add", SUBSYSTEM=="net", KERNEL=="wl*", RUN+="/usr/bin/iwctl dev $name set power_save on"

  10_pci_pm: |
    SUBSYSTEM=="pci", ATTR{power/control}="auto"

  # 10_usb_autosuspend: |
  #   ACTION=="add", SUBSYSTEM=="usb", ATTR{idVendor}=="2717", ATTR{idProduct}=="5001", GOTO="power_usb_rules_end"
  #   ACTION=="add", SUBSYSTEM=="usb", TEST=="power/control", ATTR{power/control}="auto" LABEL="power_usb_rules_end"

  10_sata_autosuspend: |
    ACTION=="add", SUBSYSTEM=="scsi_host", KERNEL=="host*", ATTR{link_power_management_policy}="med_power_with_dipm"

  20_vfio: |
    SUBSYSTEM=="vfio", OWNER="root", GROUP="kvm", MODE="0660"

  30_autorandr: |
    ACTION=="change", SUBSYSTEM=="drm", RUN+="/usr/bin/autorandr --batch --change --default default"
