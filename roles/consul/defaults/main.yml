consul_download_url: "https://releases.hashicorp.com"

consul_services: {}
consul_configs: {}
consul_scripts: {}

consul_dir: "/opt/consul"
consul_dirs:
  main:
    path: "{{ consul_dir }}"
  configs:
    path: "{{ consul_dir }}/config.d"
  services:
    path: "{{ consul_dir }}/service.d"
  certs:
    path: "{{ consul_dir }}/certs"
    mode: "u=rwX,g=rX,o="
  scripts:
    path: "{{ consul_dir }}/script.d"
  logs:
    path: "/var/log/consul"
  data:
    path: "/var/lib/consul"
    mode: "u=rwX,g=rX,o="

consul_service: |
  #!/sbin/openrc-run

  description="HashiCorp Consul - service mesh"

  group="${RC_SVCNAME}"
  user="${RC_SVCNAME}"

  rc_ulimit="-n 65536"

  supervisor="supervise-daemon"
  pidfile="/run/${RC_SVCNAME}.pid"
  command="/usr/bin/${RC_SVCNAME}"
  command_args="agent -config-file {{ consul_dir }}/consul.json -config-dir={{ consul_dirs.configs.path }} -config-dir={{ consul_dirs.services.path }}"
  command_background="true"
  extra_started_commands="reload"

  depend() {
      need net
  }

  reload() {
      ebegin "Reloading consul"
      ${command} reload
      eend $?
  }
