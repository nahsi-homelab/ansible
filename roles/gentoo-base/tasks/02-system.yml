- name: set timezone
  copy:
    content: "{{ base_timezone }}"
    dest: /etc/timezone
    owner: root
    group: root
    mode: 0644
  notify: update timezone

- name: generate locales
  copy:
    content: "{{ base_locales | join('\n') }}"
    dest: /etc/locale.gen
    owner: root
    group: root
    mode: 0644
  notify: generate locales

- name: set consolefont
  copy:
    content: >
      consolefont={{ base_consolefont }}
    dest: /etc/conf.d/consolefont

- name: set hostname
  hostname:
    name: "{{ inventory_hostname }}"
    use: openrc

- meta: flush_handlers

- name: install openresolv
  portage:
    package: net-dns/openresolv
    state: present

- name: configure openresolv
  copy:
    content: "{{ base_dns }}"
    dest: /etc/resolvconf.conf
    owner: root
    group: root
    mode: 0644
  notify: run resolvconf

- name: install base packages
  portage:
    package: "{{ item }}"
    state: present
  loop: "{{ base_packages }}"

- name: configure hwclock
  copy:
    content: "{{ base_hwclock }}"
    dest: /etc/conf.d/hwclock
    owner: root
    group: root
    mode: 0644
  when: base_hwclock is defined

- name: configure openrc
  copy:
    content: "{{ base_openrc }}"
    dest: /etc/rc.conf
    owner: root
    group: root
    mode: 0644
  when: base_openrc is defined

- name: set env vars with eselect
  eselect:
    module: "{{ item.key }}"
    target: "{{ item.value }}"
  loop: "{{ base_env | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  notify: update env

- name: configure doas
  copy:
    content: "{{ base_doas_conf }}"
    dest: /etc/doas.conf
    owner: root
    group: root
    mode: 0644

- name: enable services
  service:
    name: "{{ service.name }}"
    enabled: yes
    runlevel: "{{ service.runlevel }}"
    use: openrc
  loop: "{{ base_services }}"
  loop_control:
    loop_var: "service"
    label: "{{ service.name }}"
  when: base_services is defined

- name: mount filesystems
  mount:
    src: "{{ fs.src }}"
    opts: "{{ fs.opts }}"
    path: "{{ fs.path }}"
    fstype: "{{ fs.type }}"
    state: mounted
  loop: "{{ base_filesystems }}"
  loop_control:
    loop_var: "fs"
    label: "{{ fs.path }}"
  when: base_filesystems is defined

- name: set sysctl entries
  sysctl:
    name: "{{ sysctl.name }}"
    value: "{{ sysctl.value }}"
    state: present
  loop: "{{ base_sysctl }}"
  loop_control:
    loop_var: "sysctl"
    label: "{{ sysctl.name }}"
  when: base_sysctl is defined

- meta: flush_handlers
