nomad_download_url: "https://releases.hashicorp.com"

nomad_configs: {}

nomad_dir: "/opt/nomad"
nomad_dirs_base:
  main:
    path: "{{ nomad_dir }}"
  configs:
    path: "{{ nomad_dir }}/config.d"
  logs:
    path: "/var/log/nomad"
  data:
    path: "/var/lib/nomad"
    mode: "u=rwX,g=rX,o="
nomad_dirs_overlay: {}
nomad_dirs: >
  {{
    nomad_dirs_base |
    combine(nomad_dirs_overlay, recursive=true)
  }}

nomad_service: |
  #!/sbin/openrc-run

  description="HashiCorp Nomad - workload orchestrator"

  user="root"
  group="root"

  supervisor="supervise-daemon"
  pidfile="/run/${RC_SVCNAME}.pid"
  command="/usr/bin/${RC_SVCNAME}"
  command_args="agent -config={{ nomad_dir }}/nomad.json -config={{ nomad_dirs.configs.path }}"
  command_background="true"
  stopsig=SIGINT
  extra_started_commands="reload"

  depend() {
      need net
  }

  reload() {
      ebegin "Reloading nomad"
      ${supervisor} ${RC_SVCNAME} --signal HUP --pidfile "${PIDFILE}"
      eend $?
  }
