- name: install apcupsd
  tags: apcupsd
  portage:
    package: sys-power/apcupsd
    state: present

- name: create apcupsd directories
  tags: apcupsd
  file:
    dest: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  loop:
    - /etc/apcupsd/scripts

- name: copy apcupsd config
  tags: apcupsd
  copy:
    content: "{{ base_apcupsd_config }}"
    dest: "/etc/apcupsd/apcupsd.conf"
    owner: root
    group: root
    mode: 0640
  notify: restart apcupsd

- name: register present apcupsd scripts
  tags: apcupsd
  find:
    paths: "/etc/apcupsd/scripts/"
  register: _scripts_present

- name: copy apcupsd scripts
  tags: apcupsd
  copy:
    content: "{{ script.value }}"
    dest: "/etc/apcupsd/scripts/{{ script.key }}"
    owner: root
    group: root
    mode: 0755
  loop: "{{ base_apcupsd_scripts | dict2items }}"
  loop_control:
    loop_var: "script"
    label: "{{ script.key }}"
  register: _scripts_copied

- name: delete apcupsd scripts
  tags: apcupsd
  vars:
    _present: "{{ _scripts_present | json_query('files[*].path') | default([]) }}"
    _copied: "{{ _scripts_copied | json_query('results[*].dest') | default([]) }}"
  file:
    path: "{{ item }}"
    state: absent
  loop: "{{ _present | difference(_copied) }}"

- name: enable apcupsd
  tags: apcupsd
  service:
    name: apcupsd
    enabled: true
    runlevel: default
    use: openrc
