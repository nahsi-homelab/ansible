consul_version: "1.10.3"
consul_servers:
  - 192.168.130.10
  - 192.168.130.1
  - 192.168.230.1

gotmpl_docker: !unsafe '{{ GetInterfaceIP "docker0" }}'

consul_config_agent:
  datacenter: "oikumene"
  encrypt: "{{ lookup('hashi_vault', 'secret/data/gossip:consul') }}"

  data_dir: "/var/lib/consul/"

  enable_syslog: true
  # "trace", "debug", "info", "warn", "err"
  log_level: "info"
  syslog_facility: "LOCAL5"

  rejoin_after_leave: true

  bind_addr: "{{ gotmpl_private_address }}"
  addresses:
    http: "127.0.0.1 {{ gotmpl_private_address }} {{ gotmpl_docker }}"
    dns: "127.0.0.1 {{ gotmpl_private_address }}"
  ports:
    grpc: 8502

  connect:
    enabled: true

  enable_central_service_config: true

  enable_local_script_checks: true

  telemetry:
    disable_compat_1.9: true
    disable_hostname: true
    prometheus_retention_time: "30s"

  server: false
  retry_join: "{{ consul_servers }}"

consul_config: "{{ consul_config_agent }}"

consul_services:
  telegraf:
    service:
      id: "telegraf"
      name: "telegraf"
      port: 9271
      check:
        id: "telegraf-health"
        name: "telegraf"
        http: "http://localhost:9270"
        interval: "20s"
        timeout: "2s"

  promtail:
    service:
      id: "promtail"
      name: "promtail"
      port: 9380
      tags: ["service=system"]
      check:
        id: "promtail-health"
        name: "promtail"
        http: "http://{{ private_ip }}:9380/ready"
        interval: "20s"
        timeout: "2s"
