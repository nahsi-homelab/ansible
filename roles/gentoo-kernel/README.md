# Ansible role: gentoo-kernel

## Description
Configure and install custom Gentoo [distribution Kernel](https://wiki.gentoo.org/wiki/Project:Distribution_Kernel).

Installs and configures [rEFInd](https://rodsbooks.com/refind/configfile.html) and optionally [ZFSBootMenu](https://zfsbootmenu.org).

### Managing kernel configurations
There is a minimal kernel configuration file for each arch with sane defaults, but with platform specific options disabled (i.e. no support for AMD or Intel CPUs by default, not video drivers etc).

Minimal configuration is copied by Ansible to `/etc/portage/savedcofigs` and used instead of default config supplied by Gentoo.

Platform specific options are managed by custom [Kconfig](https://www.kernel.org/doc/html/latest/kbuild/kconfig.html) file located at `/etc/kernel/Kconfig`.

This file is sourced in Linux main Kconfig file using this [patch](files/custom-kconfig.patch).

Custom Kconfig in turn sources other Kconfig [files](files/kconfig.d/) in `/etc/kernel/kconfig.d/`. List of files is generated by Ansible and configured with `kernel_kconfigs` variable per host.

## Role Variables
| Name | Default value | Description |
| ---- | ------------- | ----------- |
| `arch` | | HW architecture: amd64, arm64 etc |
| `kernel_version` | `""` | |
| `kernel_firmware` | `[]` | list of firmware, used in `linux-firmware` saved config and in `CONFIG_EXTRA_FIRMWARE=` |
| `kernel_kconfigs` | `[]` | see <files/kconfig.d> |
| `kernel_postinst` | `[]` | scripts to run after kernel install, see <files/postinst.d> |
| `kernel_zfs_on_root` | `false` | flag to trigger zfsbootmenu install |
| `kernel_efi_device` | `""` | path to device with `/boot/efi`, example `/dev/disk/by-partlabel/EFI` |
| `kernel_refind_default` | see [](defaults/main.yml) | used to construct `/boot/efi/EFI/refind/refind.conf` |
| `kernel_refind` | `{}` | refind config, will be merged with `kernel_refind_default` |
| `kernel_refind_menu` | `[]` | see <defaults/main.yml> |

## Examples
```yaml
- name: Configure Gentoo kernel
  hosts: all
  roles:
    - gentoo-kernel
```

## Testing
Tests are automated with

- [tox](https://tox.readthedocs.io/en/latest/)
- [Molecule](http://molecule.readthedocs.org/en/latest/)
- [testinfra](https://testinfra.readthedocs.io/en/latest/index.html)

Since I don't host my own container registry at this moment you have to build container with Gentoo locally. See more at this [README](../../dockerfiles/)

To install tox run:
```sh
pip install tox
```

To run tests on all ansible versions:
```sh
tox
```

To run a custom molecule command on custom environment:
```sh
tox -e ansible29 -- molecule test -s
```

## Credits
To [Jakub Jirutka](https://github.com/jirutka) for `eselect` Ansible [module](https://github.com/gentoo-ansible/role-base/blob/master/library/eselect]).

## Author
Anatoly Laskaris
