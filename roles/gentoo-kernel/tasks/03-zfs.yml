- name: install zfsbootmenu
  portage:
    package: sys-kernel/zfsbootmenu
    state: latest
  notify:
    - rebuild kernel

- name: generate hostid
  command: zgenhostid
  args:
    creates: /etc/hostid

- name: enable zfs services
  service:
    name: "{{ service.name }}"
    enabled: yes
    runlevel: "{{ service.runlevel }}"
    use: openrc
  loop:
    - name: zfs-import
      runlevel: boot
    - name: zfs-mount
      runlevel: boot
  loop_control:
    loop_var: service
    label: "{{ service.name }}"

- name: copy zfsbootmenu config
  copy:
    content: "{{ kernel_zfsbootmenu_config | to_nice_yaml }}"
    dest: "/etc/zfsbootmenu/config.yaml"
    mode: 644
  notify:
    - rebuild kernel

- name: create portage env/sys-kernel directory
  file:
    path: "/etc/portage/env/sys-kernel"
    state: directory
    owner: root
    group: root
    mode: 640

- name: create gentoo-kernel zfsbootmenu hook
  copy:
    content: |
      if [[ $EBUILD_PHASE == "postinst" ]]; then
        elog "Generating zfsbootmenu"
        elog "$(generate-zbm --kver ${PV})"
      fi
    dest: "/etc/portage/env/sys-kernel/gentoo-kernel"
    owner: root
    group: root
    mode: 640
