- name: install crun OCI runtime
  tags: containers
  portage:
    package: app-emulation/crun
    state: present

- name: install docker and podman
  tags: containers
  portage:
    package:
      - app-emulation/docker
      - app-emulation/podman
    state: present

- name: configure containers
  tags: containers
  copy:
    content: "{{ base_containers_containers }}"
    dest: "/etc/containers/containers.conf"
    owner: root
    group: root
    mode: 0644

- name: configure containers registries
  tags: containers
  copy:
    content: "{{ base_containers_registries }}"
    dest: "/etc/containers/registries.conf"
    owner: root
    group: root
    mode: 0644

- name: configure containers policy
  tags: containers
  copy:
    content: "{{ base_containers_policy | to_nice_json }}"
    dest: "/etc/containers/policy.json"
    owner: root
    group: root
    mode: 0644

- name: configure containers storage
  tags: containers
  copy:
    content: "{{ base_containers_storage }}"
    dest: "/etc/containers/storage.conf"
    owner: root
    group: root
    mode: 0644

- name: create /etc/docker
  tags: containers
  file:
    dest: "/etc/docker"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: configure docker
  tags: containers
  copy:
    content: "{{ base_containers_docker | to_nice_json }}"
    dest: "/etc/docker/daemon.json"
    owner: root
    group: root
    mode: 0600
  notify: restart docker

- name: install docker loki plugin
  tags: containers
  community.docker.docker_plugin:
    plugin_name: grafana/loki-docker-driver
    alias: loki
    state: enable
  notify: restart docker
